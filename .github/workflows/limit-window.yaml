name: Challenge time window

on:
  push:
    branches: [ "**" ]

permissions:
  contents: write

env:
  DEADLINE_HOURS: 2

jobs:
  start-timer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure .challenge/started_at exists (first push starts the clock)
        run: |
          mkdir -p .challenge
          if [ ! -f .challenge/started_at ]; then
            date -u +%s > .challenge/started_at
            git config user.name "challenge-bot"
            git config user.email "challenge-bot@users.noreply.github.com"
            git add .challenge/started_at
            git commit -m "Start challenge timer"
            git push
          fi

  enforce-deadline:
    needs: start-timer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fail if deadline exceeded
        run: |
          if [ ! -f .challenge/started_at ]; then
            echo "No start marker found; skipping deadline check."
            exit 0
          fi

          START=$(cat .challenge/started_at)
          NOW=$(date -u +%s)
          ELAPSED=$(( NOW - START ))
          LIMIT=$(( ${DEADLINE_HOURS} * 3600 ))

          echo "Elapsed: $((ELAPSED/3600))h (limit: ${DEADLINE_HOURS}h)"

          if [ "${ELAPSED}" -gt "${LIMIT}" ]; then
            echo "::error::Time window exceeded (${ELAPSED}s > ${LIMIT}s). Further pushes will fail."
            exit 1
          fi